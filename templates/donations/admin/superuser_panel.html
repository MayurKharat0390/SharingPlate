<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superuser Verification Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-badge {
            font-size: 0.8rem;
            padding: 4px 12px;
            border-radius: 15px;
        }
        .verified { background-color: #28a745; color: white; }
        .pending { background-color: #ffc107; color: black; }
        .rejected { background-color: #dc3545; color: white; }
        .not-submitted { background-color: #6c757d; color: white; }
        .profile-card { border-left: 4px solid #007bff; }
        .seeker-card { border-left: 4px solid #28a745; }
        .dashboard-card { transition: transform 0.2s; }
        .dashboard-card:hover { transform: translateY(-2px); }
        .bulk-actions { background-color: #f8f9fa; border-radius: 8px; padding: 15px; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 mb-0">
                    <i class="fas fa-user-shield text-primary"></i>
                    Superuser Verification Panel
                </h1>
                <p class="text-muted">Manage user profiles and verification status</p>
            </div>
            <div class="col-auto">
                <a href="{% url 'admin:index' %}" class="btn btn-outline-primary">
                    <i class="fas fa-cog"></i> Django Admin
                </a>
            </div>
        </div>

        <!-- Dashboard Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card dashboard-card text-center">
                    <div class="card-body">
                        <h3 class="text-primary">{{ counts.total_donors }}</h3>
                        <p class="text-muted mb-0">Total Donors</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card dashboard-card text-center">
                    <div class="card-body">
                        <h3 class="text-success">{{ counts.verified_donors }}</h3>
                        <p class="text-muted mb-0">Verified Donors</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card dashboard-card text-center">
                    <div class="card-body">
                        <h3 class="text-warning">{{ counts.pending_donors }}</h3>
                        <p class="text-muted mb-0">Pending Donors</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card dashboard-card text-center">
                    <div class="card-body">
                        <h3 class="text-primary">{{ counts.total_seekers }}</h3>
                        <p class="text-muted mb-0">Total Seekers</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card dashboard-card text-center">
                    <div class="card-body">
                        <h3 class="text-success">{{ counts.verified_seekers }}</h3>
                        <p class="text-muted mb-0">Verified Seekers</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card dashboard-card text-center">
                    <div class="card-body">
                        <h3 class="text-warning">{{ counts.pending_requests }}</h3>
                        <p class="text-muted mb-0">Pending Requests</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Profile Type</label>
                        <select name="type" class="form-select">
                            <option value="all" {% if current_filters.type == 'all' %}selected{% endif %}>All Profiles</option>
                            <option value="donor" {% if current_filters.type == 'donor' %}selected{% endif %}>Donors Only</option>
                            <option value="seeker" {% if current_filters.type == 'seeker' %}selected{% endif %}>Seekers Only</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Verification Status</label>
                        <select name="status" class="form-select">
                            <option value="all" {% if current_filters.status == 'all' %}selected{% endif %}>All Status</option>
                            {% for status, label in verification_status_choices %}
                                <option value="{{ status }}" {% if current_filters.status == status %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Search</label>
                        <input type="text" name="q" class="form-control" placeholder="Search by name, email, city..." value="{{ current_filters.q }}">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Bulk Actions -->
        <div class="bulk-actions mb-4">
            <form id="bulkVerifyForm" method="post" action="{% url 'bulk_verify_profiles' %}">
                {% csrf_token %}
                <input type="hidden" name="donor_ids" id="bulkDonorIds">
                <input type="hidden" name="seeker_ids" id="bulkSeekerIds">
                <button type="submit" class="btn btn-success btn-sm">
                    <i class="fas fa-check-circle"></i> Verify Selected
                </button>
            </form>
            <form id="bulkDeleteForm" method="post" action="{% url 'bulk_delete_profiles' %}" class="mt-2">
                {% csrf_token %}
                <input type="hidden" name="donor_ids" id="bulkDeleteDonorIds">
                <input type="hidden" name="seeker_ids" id="bulkDeleteSeekerIds">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="delete_users" value="true" id="deleteUsers">
                    <label class="form-check-label" for="deleteUsers">
                        Also delete user accounts
                    </label>
                </div>
                <button type="submit" class="btn btn-danger btn-sm mt-2" onclick="return confirm('Are you sure you want to delete selected profiles?')">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
            </form>
        </div>

        <!-- Donor Profiles -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-hand-holding-heart"></i>
                    Donor Profiles ({{ donor_profiles.count }})
                </h5>
            </div>
            <div class="card-body">
                {% if donor_profiles %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllDonors"></th>
                                <th>Username</th>
                                <th>Organization</th>
                                <th>Type</th>
                                <th>City</th>
                                <th>Status</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for donor in donor_profiles %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="donor-checkbox" value="{{ donor.id }}">
                                </td>
                                <td>
                                    <strong>{{ donor.user.username }}</strong>
                                    <br><small class="text-muted">{{ donor.user.email }}</small>
                                </td>
                                <td>{{ donor.organization_name|default:"Individual" }}</td>
                                <td>{{ donor.get_user_type_display }}</td>
                                <td>{{ donor.city }}</td>
                                <td>
                                    <span class="status-badge {{ donor.verification_status }}">
                                        {{ donor.get_verification_status_display }}
                                    </span>
                                </td>
                                <td>{{ donor.created_at|date:"M d, Y" }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% if donor.verification_status != 'verified' %}
                                        <form method="post" action="{% url 'verify_profile' 'donor' donor.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-success btn-sm" title="Verify">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                        
                                        {% if donor.verification_status != 'rejected' %}
                                        <form method="post" action="{% url 'reject_profile' 'donor' donor.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-warning btn-sm" title="Reject">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                        
                                        <form method="post" action="{% url 'delete_profile' 'donor' donor.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="delete_user" value="false">
                                            <button type="submit" class="btn btn-danger btn-sm" 
                                                    onclick="return confirm('Delete donor profile for {{ donor.user.username }}?')"
                                                    title="Delete Profile">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">No donor profiles found.</p>
                {% endif %}
            </div>
        </div>

        <!-- Help Seeker Profiles -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-hands-helping"></i>
                    Help Seeker Profiles ({{ seeker_profiles.count }})
                </h5>
            </div>
            <div class="card-body">
                {% if seeker_profiles %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllSeekers"></th>
                                <th>Organization</th>
                                <th>Type</th>
                                <th>City</th>
                                <th>Status</th>
                                <th>Urgent</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for seeker in seeker_profiles %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="seeker-checkbox" value="{{ seeker.id }}">
                                </td>
                                <td>
                                    <strong>{{ seeker.organization_name }}</strong>
                                    <br><small class="text-muted">{{ seeker.user.username }}</small>
                                </td>
                                <td>{{ seeker.seeker_type.name }}</td>
                                <td>{{ seeker.city }}</td>
                                <td>
                                    <span class="status-badge {{ seeker.verification_status }}">
                                        {{ seeker.get_verification_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if seeker.is_urgent %}
                                    <span class="badge bg-danger">Urgent</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Normal</span>
                                    {% endif %}
                                </td>
                                <td>{{ seeker.created_at|date:"M d, Y" }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        {% if seeker.verification_status != 'verified' %}
                                        <form method="post" action="{% url 'verify_profile' 'seeker' seeker.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-success btn-sm" title="Verify">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                        
                                        {% if seeker.verification_status != 'rejected' %}
                                        <form method="post" action="{% url 'reject_profile' 'seeker' seeker.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-warning btn-sm" title="Reject">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                        
                                        <form method="post" action="{% url 'delete_profile' 'seeker' seeker.id %}" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="delete_user" value="false">
                                            <button type="submit" class="btn btn-danger btn-sm" 
                                                    onclick="return confirm('Delete help seeker profile for {{ seeker.organization_name }}?')"
                                                    title="Delete Profile">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-3">No help seeker profiles found.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Bulk selection for donors
        document.getElementById('selectAllDonors').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.donor-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = this.checked);
            updateBulkActions();
        });

        // Bulk selection for seekers
        document.getElementById('selectAllSeekers').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.seeker-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = this.checked);
            updateBulkActions();
        });

        // Update bulk actions when checkboxes change
        document.querySelectorAll('.donor-checkbox, .seeker-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkActions);
        });

        function updateBulkActions() {
            const donorIds = Array.from(document.querySelectorAll('.donor-checkbox:checked'))
                .map(checkbox => checkbox.value);
            const seekerIds = Array.from(document.querySelectorAll('.seeker-checkbox:checked'))
                .map(checkbox => checkbox.value);

            document.getElementById('bulkDonorIds').value = donorIds.join(',');
            document.getElementById('bulkSeekerIds').value = seekerIds.join(',');
            document.getElementById('bulkDeleteDonorIds').value = donorIds.join(',');
            document.getElementById('bulkDeleteSeekerIds').value = seekerIds.join(',');
        }

        // Initialize
        updateBulkActions();
    </script>
</body>
</html>